

## 一 CPU指令结构

<img src="C:\Users\MSY\AppData\Roaming\Typora\typora-user-images\image-20210831143508223.png" alt="image-20210831143508223" style="zoom: 67%;" />

#### 控制单元

控制单元是整个CPU的指挥控制中心，由指令寄存器IR（Instruction Register）、指 令译码器ID（Instruction Decoder）和 操作控制器OC（Operation Controller） 等组 成，对协调整个电脑有序工作极为重要。它根据用户预先编好的程序，依次从存储器中取出 各条指令，放在指令寄存器IR中，通过指令译码（分析）确定应该进行什么操作，然后通过 操作控制器OC，按确定的时序，向相应的部件发出微操作控制信号。操作控制器OC中主要 包括：节拍脉冲发生器、控制矩阵、时钟脉冲发生器、复位电路和启停电路等控制逻辑。

#### 运算单元

运算单元是运算器的核心。可以执行算术运算（包括加减乘数等基本运算及其附加运 算）和逻辑运算（包括移位、逻辑测试或两个值比较）。相对控制单元而言，运算器接受控 制单元的命令而进行动作，即运算单元所进行的全部操作都是由控制单元发出的控制信号来 指挥的，所以它是执行部件。

#### 存储单元

存储单元包括 CPU 片内缓存Cache和寄存器组，是 CPU 中暂时存放数据的地方，里 面保存着那些等待处理的数据，或已经处理过的数据，CPU 访问寄存器所用的时间要比访 问内存的时间短。 寄存器是CPU内部的元件，寄存器拥有非常高的读写速度，所以在寄存 器之间的数据传送非常快。采用寄存器，可以减少 CPU 访问内存的次数，从而提高了 CPU 的工作速度。寄存器组可分为专用寄存器和通用寄存器。专用寄存器的作用是固定的，分别 寄存相应的数据；而通用寄存器用途广泛并可由程序员规定其用途。





## 二 CPU缓存结构

<img src="C:\Users\MSY\AppData\Roaming\Typora\typora-user-images\image-20210831143925834.png" alt="image-20210831143925834" style="zoom:67%;" />

存储器存储空间大小：内存>L3>L2>L1>寄存器； 

存储器速度快慢排序：寄存器>L1>L2>L3>内存； 

还有一点值得注意的是：缓存是由最小的存储区块-缓存行(cacheline)组成，缓存行大小通 常为64byte。 

缓存行是什么意思呢？ 比如你的L1缓存大小是512kb,而**cacheline = 64byte**,那么就是L1里有512 * 1024/64个 cacheline



#### CPU读取存储器数据过程

> 1、CPU要取寄存器X的值，只需要一步：直接读取。 
>
> 2、CPU要取L1 cache的某个值，需要1-3步（或者更多）：把cache行锁住，把某个数据拿来，解 锁，如果没锁住就慢了。 
>
> 3、CPU要取L2 cache的某个值，先要到L1 cache里取，L1当中不存在，在L2里，L2开始加锁，加 锁以后，把L2里的数据复制到L1，再执行读L1的过程，上面的3步，再解锁。 
>
> 4、CPU取L3 cache的也是一样，只不过先由L3复制到L2，从L2复制到L1，从L1到CPU。 
>
> 5、CPU取内存则最复杂：通知内存控制器占用总线带宽，通知内存加锁，发起内存读请求，等待 回应，回应数据保存到L3（如果没有就到L2），再从L3/2到L1，再从L1到CPU，之后解除总线锁 定。

#### CPU读内存原则

> 1. 时间局部性
> 2. 空间局部性
>
> 例子：二维数组按行读取和按列读取的效率问题
>
> 答：数组在内存中地址连续，所以按行读取，即完整的一维数组的一个元素地址，会一次性被缓存到缓存行里（64字节），比按列（地址跳跃，缓存的大部分数据会无用，然后再次从主存中读取缓存）快很多。



## 三 操作系统内存管理

#### 线程上下文切换

概念：保存上一个线程的执行状态，切换到下一个线程

- 上下文：线程栈（PC计数器、本地变量表、操作数栈）
- 上下文切换：由操作系统堆CPU发出中断信号，让cpu跳转执行中断号指定的代码

##### 线程的状态切换：用户态 -- 内核态相互切换

> 每个线程都有两块栈和堆，分为别用户态和内核态，

#### 执行空间保护

